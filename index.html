<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ°¸æ’ä¸‹è½ (Eternal Descent)</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; /* ç¦æ­¢æ‰‹æœºé»˜è®¤è§¦æ‘¸è¡Œä¸º */
            cursor: default;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* è®©é¼ æ ‡äº‹ä»¶ç©¿é€åˆ° Canvas */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 10;
        }
        /* åˆ†æ•°æ˜¾ç¤º */
        .score-display {
            position: absolute;
            top: 20px;
            left: 20px;
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.7);
            z-index: 5;
        }
        /* æ¸¸æˆç»“æŸ/å¼€å§‹ é¢æ¿ */
        .panel {
            background: rgba(0, 0, 0, 0.85);
            padding: 40px;
            border-radius: 15px;
            border: 2px solid #0ff;
            box-shadow: 0 0 20px #0ff;
            pointer-events: auto; /* å…è®¸ç‚¹å‡»æŒ‰é’® */
            display: flex;
            flex-direction: column;
            align-items: center;
            backdrop-filter: blur(5px);
        }
        h1 { 
            color: #0ff; 
            margin: 0 0 10px 0; 
            text-transform: uppercase; 
            letter-spacing: 2px; 
            font-size: 32px;
        }
        p { color: #fff; font-size: 18px; margin: 10px 0; }
        
        /* éœ“è™¹æŒ‰é’® */
        .btn-start {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 20px;
            background: transparent;
            color: #0ff;
            border: 2px solid #0ff;
            border-radius: 30px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.3);
            transition: all 0.2s;
        }
        .btn-start:hover {
            background: #0ff;
            color: #000;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            transform: scale(1.05);
        }
        .btn-start:active { transform: scale(0.95); }

        .hidden { display: none !important; }
        
        /* æ“ä½œæç¤º */
        .tutorial {
            margin-top: 15px;
            color: rgba(255,255,255,0.6);
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div class="score-display">æ·±åº¦: <span id="scoreVal">0</span>m</div>

    <div id="ui-layer">
        <!-- å¼€å§‹èœå• -->
        <div id="startScreen" class="panel">
            <h1>æ°¸æ’ä¸‹è½</h1>
            <p>å‡†å¤‡å¥½å å…¥æ·±æ¸Šäº†å—ï¼Ÿ</p>
            <button class="btn-start" onclick="startGame()">å¼€å§‹ä¸‹è½</button>
            <div class="tutorial">ğŸ–±ï¸ å·¦å³ç§»åŠ¨é¼ æ ‡ / ğŸ‘† å·¦å³æ»‘åŠ¨æ‰‹æŒ‡</div>
        </div>

        <!-- ç»“æŸèœå• (é»˜è®¤éšè—) -->
        <div id="gameOverScreen" class="panel hidden">
            <h1 style="color: #ff0055; border-color: #ff0055;">ä¿¡å·ä¸¢å¤±</h1>
            <p>æœ€ç»ˆæ·±åº¦: <span id="finalScore" style="font-size: 24px; font-weight: bold;">0</span>m</p>
            <button class="btn-start" style="border-color: #ff0055; color: #ff0055;" onclick="startGame()" onmouseover="this.style.background='#ff0055'; this.style.color='white'" onmouseout="this.style.background='transparent'; this.style.color='#ff0055'">å†æ¬¡å°è¯•</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('scoreVal');
    const finalScoreEl = document.getElementById('finalScore');
    const startScreen = document.getElementById('startScreen');
    const gameOverScreen = document.getElementById('gameOverScreen');

    // æ¸¸æˆçŠ¶æ€
    let isPlaying = false;
    let score = 0;
    let speed = 5;
    let frames = 0;
    let animationId;

    // å±å¹•é€‚é…
    let width, height;
    function resize() {
        width = canvas.width = window.innerWidth;
        height = canvas.height = window.innerHeight;
        // é‡æ–°è°ƒæ•´ç©å®¶ä½ç½®
        if(!isPlaying) {
             player.x = width / 2;
             player.targetX = width / 2;
             drawIntro(); // ç»˜åˆ¶é™æ€èƒŒæ™¯
        }
    }
    window.addEventListener('resize', resize);

    // ç©å®¶å¯¹è±¡
    const player = {
        x: 0, y: 0,
        radius: 12,
        color: '#0ff',
        targetX: 0,
        trail: []
    };

    let obstacles = [];
    let particles = [];

    // è¾“å…¥æ§åˆ¶ (ä»…åœ¨æ¸¸æˆè¿›è¡Œæ—¶ç”Ÿæ•ˆ)
    function handleInput(x) {
        if (isPlaying) {
            player.targetX = x;
        }
    }

    window.addEventListener('mousemove', e => handleInput(e.clientX));
    window.addEventListener('touchmove', e => {
        e.preventDefault();
        handleInput(e.touches[0].clientX);
    }, {passive: false});
    window.addEventListener('touchstart', e => {
        if(isPlaying) handleInput(e.touches[0].clientX);
    });

    // å¼€å§‹æ¸¸æˆé€»è¾‘
    function startGame() {
        // é‡ç½®æ•°æ®
        isPlaying = true;
        score = 0;
        speed = 5;
        frames = 0;
        obstacles = [];
        player.trail = [];
        
        // éšè—UI
        startScreen.classList.add('hidden');
        gameOverScreen.classList.add('hidden');
        
        // åˆå§‹åŒ–ä½ç½®
        player.x = width / 2;
        player.targetX = width / 2; // å…³é”®ï¼šé‡ç½®ç›®æ ‡ä½ç½®ï¼Œé˜²æ­¢å¼€å±€ç¬ç§»
        player.y = height * 0.2;

        // éšè—é¼ æ ‡æŒ‡é’ˆ (æ²‰æµ¸æ„Ÿ)
        document.body.style.cursor = 'none';

        // å¯åŠ¨å¾ªç¯
        if (animationId) cancelAnimationFrame(animationId);
        loop();
    }

    // æ¸¸æˆç»“æŸ
    function gameOver() {
        isPlaying = false;
        document.body.style.cursor = 'default'; // æ¢å¤é¼ æ ‡
        finalScoreEl.innerText = Math.floor(score);
        gameOverScreen.classList.remove('hidden');
    }

    // ç”Ÿæˆéšœç¢ç‰©
    function spawnObstacle() {
        const type = Math.random() > 0.5 ? 'rect' : 'gap';
        const obsY = height + 50; 
        
        if (type === 'rect') {
            const w = Math.random() * (width * 0.4) + 60;
            const x = Math.random() * (width - w);
            obstacles.push({ x, y: obsY, w, h: 40 }); // å¢åŠ ä¸€ç‚¹åšåº¦
        } else {
            const gapSize = 110; 
            const gapX = Math.random() * (width - gapSize);
            obstacles.push({ x: 0, y: obsY, w: gapX, h: 40 });
            obstacles.push({ x: gapX + gapSize, y: obsY, w: width - (gapX + gapSize), h: 40 });
        }
    }

    function updateParticles() {
        if (frames % 2 === 0) {
            particles.push({
                x: Math.random() * width,
                y: height + 20,
                speed: Math.random() * 10 + 10,
                length: Math.random() * 30 + 10
            });
        }
        for (let i = particles.length - 1; i >= 0; i--) {
            let p = particles[i];
            p.y -= p.speed * (speed / 5);
            if (p.y < -50) particles.splice(i, 1);
        }
    }

    // é™æ€èƒŒæ™¯ (æœªå¼€å§‹æ—¶æ˜¾ç¤º)
    function drawIntro() {
        ctx.fillStyle = '#111';
        ctx.fillRect(0, 0, width, height);
        // ç®€å•çš„ç½‘æ ¼èƒŒæ™¯
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 1;
        for(let i=0; i<width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,height); ctx.stroke(); }
        for(let i=0; i<height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(width,i); ctx.stroke(); }
    }

    // ä¸»å¾ªç¯
    function loop() {
        if (!isPlaying) return;

        ctx.clearRect(0, 0, width, height);

        // 1. èƒŒæ™¯ç²’å­
        updateParticles();
        ctx.fillStyle = 'rgba(255, 255, 255, 0.08)';
        particles.forEach(p => ctx.fillRect(p.x, p.y, 2, p.length));

        // 2. é€»è¾‘æ›´æ–°
        frames++;
        score += 0.1;
        if (frames % 600 === 0) speed += 0.5;
        scoreEl.innerText = Math.floor(score);

        // ç©å®¶ç§»åŠ¨ (å¹³æ»‘)
        player.x += (player.targetX - player.x) * 0.15;
        // è¾¹ç•Œ
        if (player.x < player.radius) player.x = player.radius;
        if (player.x > width - player.radius) player.x = width - player.radius;

        // æ‹–å°¾
        player.trail.push({x: player.x, y: player.y});
        if (player.trail.length > 12) player.trail.shift();

        // ç”Ÿæˆéšœç¢
        let spawnRate = Math.max(25, 60 - Math.floor(speed * 2));
        if (frames % spawnRate === 0) spawnObstacle();

        // 3. éšœç¢ç‰©å¤„ç†
        ctx.fillStyle = '#ff0055';
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#ff0055';
        
        for (let i = obstacles.length - 1; i >= 0; i--) {
            let obs = obstacles[i];
            obs.y -= speed;

            ctx.fillRect(obs.x, obs.y, obs.w, obs.h);

            // ç¢°æ’æ£€æµ‹
            // ç®€å•çš„ AABB ç¢°æ’ä¼˜åŒ– (å…ˆæ£€æµ‹Yè½´èŒƒå›´ï¼Œå‡å°‘è®¡ç®—)
            if (player.y + player.radius > obs.y && player.y - player.radius < obs.y + obs.h) {
                // å†æ£€æµ‹Xè½´
                if (player.x + player.radius > obs.x && player.x - player.radius < obs.x + obs.w) {
                   gameOver();
                }
            }

            if (obs.y < -50) obstacles.splice(i, 1);
        }
        ctx.shadowBlur = 0;

        // 4. ç»˜åˆ¶ç©å®¶
        for (let i = 0; i < player.trail.length; i++) {
            let opacity = i / player.trail.length;
            ctx.beginPath();
            ctx.arc(player.trail[i].x, player.trail[i].y, player.radius * (0.6 + opacity*0.4), 0, Math.PI * 2);
            ctx.fillStyle = `rgba(0, 255, 255, ${opacity * 0.4})`;
            ctx.fill();
        }
        
        ctx.beginPath();
        ctx.arc(player.x, player.y, player.radius, 0, Math.PI * 2);
        ctx.fillStyle = player.color;
        ctx.shadowBlur = 20;
        ctx.shadowColor = player.color;
        ctx.fill();
        ctx.shadowBlur = 0;

        // è¾¹ç¼˜å‘å…‰çº¿
        ctx.strokeStyle = '#222';
        ctx.lineWidth = 4;
        ctx.strokeRect(0,0,width,height);

        animationId = requestAnimationFrame(loop);
    }

    // åˆå§‹åŒ–
    resize();
    
    // å¦‚æœé¼ æ ‡ä½ç½®å·²çŸ¥ï¼Œåˆå§‹åŒ–targetXï¼Œé¿å…å¼€å§‹æ—¶è·³è·ƒ
    window.addEventListener('mousemove', (e) => {
        if(!isPlaying) player.targetX = e.clientX; 
    }, {once:true});

</script>
</body>
</html>